<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;5.&nbsp;Advanced Topics</title><link rel="stylesheet" href="css/docbook-style.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"><link rel="start" href="user-guide.html" title="SymmetricDS 2 User Guide"><link rel="up" href="user-guide.html" title="SymmetricDS 2 User Guide"><link rel="prev" href="configuration.html" title="Chapter&nbsp;4.&nbsp;Configuration"><link rel="next" href="extensions.html" title="Chapter&nbsp;6.&nbsp;Extending SymmetricDS"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns:fo="http://www.w3.org/1999/XSL/Format" id="banner"><a style="border:none;" href="http://www.symmetricds.org/" title="SymmetricDS User Guide"><img style="border:none;" alt="SymmetricDS" src="images/banner-logo.gif"></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="advanced-topics"></a>Chapter&nbsp;5.&nbsp;Advanced Topics</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="advanced-topics.html#advanced-sync">5.1. Advanced Synchronization</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#bi-direction-sync">5.1.1. Bi-Directional Synchronization</a></span></dt><dt><span class="section"><a href="advanced-topics.html#multi-tier">5.1.2. Multi-Tiered Synchronization</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#registration-redirect">5.1.2.1. Registration Redirect</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="advanced-topics.html#jobs">5.2. Jobs</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#routing-job">5.2.1. Route Job</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#routing-job-overview">5.2.1.1. Overview</a></span></dt><dt><span class="section"><a href="advanced-topics.html#data-gaps">5.2.1.2. Data Gaps</a></span></dt></dl></dd><dt><span class="section"><a href="advanced-topics.html#controlling-synchronization">5.2.2. Controlling Synchronization Frequency</a></span></dt><dt><span class="section"><a href="advanced-topics.html#sync-triggers">5.2.3. Sync Triggers Job</a></span></dt></dl></dd><dt><span class="section"><a href="advanced-topics.html#jms-publishing">5.3. JMS Publishing</a></span></dt><dt><span class="section"><a href="advanced-topics.html#deployment-options">5.4. Deployment Options</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#deployment-options-web-archive">5.4.1. Web Archive</a></span></dt><dt><span class="section"><a href="advanced-topics.html#deployment-options-standalone">5.4.2. Standalone</a></span></dt><dt><span class="section"><a href="advanced-topics.html#deployment-options-embedded">5.4.3. Embedded</a></span></dt></dl></dd><dt><span class="section"><a href="advanced-topics.html#running-service">5.5. Running SymmetricDS as a Service</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#running-service-windows">5.5.1. Running as a Windows Service</a></span></dt><dt><span class="section"><a href="advanced-topics.html#running-service-unix">5.5.2. Running as a *nix Service</a></span></dt></dl></dd><dt><span class="section"><a href="advanced-topics.html#clustering">5.6. Clustering</a></span></dt><dt><span class="section"><a href="advanced-topics.html#encrypted-passwords">5.7. Encrypted Passwords</a></span></dt><dt><span class="section"><a href="advanced-topics.html#secure-transport">5.8. Secure Transport</a></span></dt><dd><dl><dt><span class="section"><a href="advanced-topics.html#secure-transport-sym">5.8.1. Sym Launcher</a></span></dt><dt><span class="section"><a href="advanced-topics.html#secure-transport-tomcat">5.8.2. Tomcat</a></span></dt><dt><span class="section"><a href="advanced-topics.html#secure-transport-keystore">5.8.3. Keystores</a></span></dt><dt><span class="section"><a href="advanced-topics.html#secure-transport-keys">5.8.4. Generating Keys</a></span></dt></dl></dd><dt><span class="section"><a href="advanced-topics.html#basic-auth">5.9. Basic Authentication</a></span></dt><dt><span class="section"><a href="advanced-topics.html#multi-server">5.10. Multi-Server Mode</a></span></dt></dl></div>
    
    <p>
       This chapter focuses on a variety of topics, including deployment options, jobs, clustering, encryptions, synchronization control, 
       and configuration of SymmetricDS.
    </p>

 <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="advanced-sync"></a>5.1.&nbsp;Advanced Synchronization</h2></div></div></div>
    
 <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="bi-direction-sync"></a>5.1.1.&nbsp;Bi-Directional Synchronization</h3></div></div></div>
        
        <p>
            SymmetricDS allows tables to be synchronized bi-directionally.  Note that an outgoing 
            synchronization does not process changes during an incoming synchronization on the same node unless the trigger 
            was created with the <code class="literal">sync_on_incoming_batch</code> flag set.  If the <code class="literal">sync_on_incoming_batch</code> flag
            is set, then update loops are prevented by a feature that is available in most database dialects.  
            More specifically, during an incoming synchronization the source <code class="literal">node_id</code> is put into a database session variable that is 
            available to the database trigger.  Data events are not generated if the target <code class="literal">node_id</code> 
            on an outgoing synchronization is equal to the source <code class="literal">node_id</code>.  
        </p>     
        <p>
            By default, only the columns that changed will be updated in the target system.
        </p>  
        <p>
            More complex conflict resolution strategies can be accomplished by using the 
            <code class="literal">IDataLoaderFilter</code> extension point which has access to both 
            old and new data.
        </p>         
    </div>     
      
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="multi-tier"></a>5.1.2.&nbsp;Multi-Tiered Synchronization</h3></div></div></div>
        
        <p>
            As shown in <a href="planning.html#organizing-nodes" title="3.2.&nbsp;Organizing Nodes">Section&nbsp;3.2, &#8220;Organizing Nodes&#8221;</a>, there may be
            scenarios where data needs to flow through multiple tiers of nodes that
            are organized in a tree-like network with each tier requiring a different subset of data.  For example,
            you may have a system where the lowest tier may by a computer or device located in a store.  Those devices 
            may connect to a server located physically at that store.  Then the store server may communicate with 
            a corporate server for example.  In this case, the three tiers would be device, store, and corporate.
            Each tier is typically represented by a node group.  Each node in 
            the tier would belong to the node group representing that tier.   
        </p>
        <p>
            A node will always push and pull data to other node groups according to the node group link configuration.
            A node can only pull and push data to other nodes that are represented <code class="literal">node</code> table in its database and 
            having <code class="literal">sync_enabled = 1</code>.
            Because of this, a tree-like 
            hierarchy of nodes can be created by having only a subset of nodes belonging to the same node group represented at the different branches of the tree.  
        </p>
        <p>
            If auto registration is turned <span class="emphasis"><em>off</em></span>, then this setup must occur manually by opening registration 
            for the desired nodes at the desired parent node and by configuring each node's <code class="literal">registration.url</code>
             to be the parent node's URL.  
            The parent node is always tracked by the setting of the parent's <code class="literal">node_id</code> in the <code class="literal">created_at_node_id</code> column of the new node.  
            When a node registers and downloads its configuration it is always provided the configuration for nodes 
            that might register with the node itself based on the Node Group Links defined in the parent node.
        </p>
                
 
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="registration-redirect"></a>5.1.2.1.&nbsp;Registration Redirect</h4></div></div></div>
            
        <p>
            When deploying a multi-tiered system it may be advantageous to have only one registration server, even though the parent node of a registering node
            could be any of a number of nodes in the system.  In SymmetricDS the parent node is always the node that a child registers with.  The 
            <a href="data-model.html#table_registration_redirect" title="A.17.&nbsp;REGISTRATION_REDIRECT">REGISTRATION_REDIRECT</a> table allows a single node, usually the root server in the network, to
            redirect registering nodes to their true parents.  It does so based on a mapping found in the table of the external id (<code class="literal">registrant_external_id</code>) to the parent's node 
            id (<code class="literal">registration_node_id</code>).
        </p>
        <p>
            For example, if it is desired to have a series of regional servers that workstations at retail stores get assigned to based on their <code class="literal">external_id</code>, the store number, then
            you might insert into <a href="data-model.html#table_registration_redirect" title="A.17.&nbsp;REGISTRATION_REDIRECT">REGISTRATION_REDIRECT</a> the store number as the <code class="literal">registrant_external_id</code> and the <code class="literal">node_id</code> of
            the assigned region as the <code class="literal">registration_node_id</code>.  When a workstation at the store registers, the root server send an HTTP redirect to the <code class="literal">sync_url</code> of the node 
            that matches the <code class="literal">registration_node_id</code>. 
        </p>
        <div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3>
            <p>Please see <a href="configuration.html#configuration-initial-load" title="4.6.3.1.&nbsp;Initial Load">Section&nbsp;4.6.3.1, &#8220;Initial Load&#8221;</a> for important details around initial loads
            and registration when using registration redirect.
            </p>
            </div>
            
    </div>
    </div>
</div>
          
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jobs"></a>5.2.&nbsp;Jobs</h2></div></div></div>
     
    <p>
        The SymmetricDS software allows for outgoing and incoming changes to be synchronized
        to/from other databases.  The node that initiates a synchronization connection is the client, and the
        node receiving a connection is the host.  Because synchronization is configurable to
        push or pull in either direction, the same node can act as either a client or a host
        in different circumstances.
    </p>
    <p>
        The SymmetricDS software consists of a series of background jobs, managers, Servlets, and services wired together
        via dependency injection using the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://springframework.org" target="_top">Spring Framework</a>.
    </p>    
     
    <p>
        As a client, the node runs the router job, push job and pull job on a timer thread.  
        The router job uses services to create batches that are targeted at certain nodes.  
        The push job uses services to extract and stream data to
        another node (that is, it pushes data).  The response from a push is a list
        of batch acknowlegements to indicate that data was loaded.
        The pull job uses services to load data that is streamed from another node
        (<span class="emphasis"><em>i.e.</em></span>, it pulls data).  After loading data, a second connection is made to send a list
        of batch acknowlegements.
    </p>
    <p>
        As a host, the node waits for incoming connections that pull, push, or acknowledge data changes.
        The push Servlet uses services to load data that is pushed from a client node.
        After loading data, it responds with a list of batch acknowledgements.
        The pull Servlet uses services to extract, and stream data back to the client node.
        The ack Servlet uses services to update the status of data that was loaded at a client node.  The router
        job batches and routes data.
    </p>
    <p>
        By default, data is extracted from the source database into memory until a threshold size is reached.
        If the threshold size is reached, data is streamed to a temporary file in the JVM's default temporary 
        directory.  Next, the data is streamed to the target node across the transport layer.  The receiving
        node will cache the data in memory until the threshold size is reached, writing to a temporary file if
        necessary.  At last, the data is loaded into the target database by the data loader.  This step by step
        approach allows for extract time, transport time, and load time to all be measured independently.  It 
        also allows database resources to be used most optimally.
    </p>    
    <p>
        The transport manager handles the incoming and outgoing streams of data between nodes.
        The default transport is based on a simple implementation over HTTP.  An internal transport
        is also provided.  It is possible to add other implementations, such as a socket-based transport manager.
    </p> 
    <p>
        Node communication over HTTP is represented in the following figure.
    </p> 
    <p>
        </p><div class="figure"><a name="d4e1020"></a><div class="figure-contents">
            
            <div class="mediaobject"><img src="./images/seq-node-communication.gif" alt="Node Communication"></div>
        </div><p class="title"><b>Figure&nbsp;5.1.&nbsp;Node Communication</b></p></div><p><br class="figure-break">
    </p>    
    <p>
        The <code class="literal">StandaloneSymmetricEngine</code> is wrapper API that can be used to directly start the client services only.  The 
        <code class="literal">SymmetricWebServer</code> is a wrapper API that can be used to directly start <span class="emphasis"><em>both</em></span> the
        client and host services inside a Jetty web container.  The <code class="literal">SymmetricLauncher</code> provides command line tools to work 
        with and start SymmetricDS.
    </p>   
    
  <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="routing-job"></a>5.2.1.&nbsp;Route Job</h3></div></div></div>
    
        <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="routing-job-overview"></a>5.2.1.1.&nbsp;Overview</h4></div></div></div>
        
      <p>
        The SymmetricDS-created database triggers cause data to be capture in the <a href="data-model.html#table_data" title="A.20.&nbsp;DATA">DATA</a> table.
        The next step in the synchronization process is to process the change data to determine which nodes, if any, the data should
        be routed to.  This step is performed by the <span class="emphasis"><em>Route Job</em></span>.  In addition to determining which nodes data will
        be sent to, the Route Job is also responsible for determing how much data will be batched together for transport. 
        It is a single background task that inserts into <a href="data-model.html#table_data_event" title="A.23.&nbsp;DATA_EVENT">DATA_EVENT</a> 
        and <a href="data-model.html#table_outgoing_batch" title="A.24.&nbsp;OUTGOING_BATCH">OUTGOING_BATCH</a>.  
     </p>
     <p>
         At a high level, the Route Job is straightforward.  It collects a list of data ids from <a href="data-model.html#table_data" title="A.20.&nbsp;DATA">DATA</a> 
         which haven't yet been routed (see <a href="advanced-topics.html#data-gaps" title="5.2.1.2.&nbsp;Data Gaps">Section&nbsp;5.2.1.2, &#8220;Data Gaps&#8221;</a> for much more detail about this step), 
         one channel at a time, up to a limit specified by the channel configuration
         (<code class="literal">max_data_to_route</code>, on  <a href="data-model.html#table_channel" title="A.10.&nbsp;CHANNEL">CHANNEL</a>).
         The data is then batched based on the <code class="literal">batch_algorithm</code> defined for the channel and as documented in 
          <a href="configuration.html#configuration-channel" title="4.5.&nbsp;Channel">Section&nbsp;4.5, &#8220;Channel&#8221;</a>.  Note that, for the default batching algorithm, there may actually be more than <code class="literal">max_data_to_route</code> included depending
         on the transaction boundaries.  The mapping of data to specific nodes, organized into batches, is then 
         recorded in    <a href="data-model.html#table_outgoing_batch" title="A.24.&nbsp;OUTGOING_BATCH">OUTGOING_BATCH</a> with a status of "RT" in each case (representing the
         fact that the Route Job is still running).
         Once the routing algorithms and batching are completed, the batches are organized with their corresponding data ids 
         and saved in <a href="data-model.html#table_data_event" title="A.23.&nbsp;DATA_EVENT">DATA_EVENT</a>.  Once <a href="data-model.html#table_data_event" title="A.23.&nbsp;DATA_EVENT">DATA_EVENT</a> is
         updated, the rows in <a href="data-model.html#table_outgoing_batch" title="A.24.&nbsp;OUTGOING_BATCH">OUTGOING_BATCH</a> are updated to a status of New "NE".
    </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="data-gaps"></a>5.2.1.2.&nbsp;Data Gaps</h4></div></div></div>
        
      <p>
      On the surface, the first Route Job step of collecting unrouted data ids seems simple: assign
     sequential data ids for each data row as it's inserted and keep track of which data id was last routed and start from there.  The difficulty arises, however, due to the fact that 
     there can be multiple transactions inserting into <a href="data-model.html#table_data" title="A.20.&nbsp;DATA">DATA</a> simultaneously.
     As such, a given section of rows in the  <a href="data-model.html#table_data" title="A.20.&nbsp;DATA">DATA</a> table may actually contain "gaps" in the data ids when the Route Job is executing.
     Most of these gaps are only temporarily and fill in at some point after routing and need to be picked up with the next run of the Route Job.  Thus, the Route Job needs to
     remember to route the filled-in gaps.  Worse yet, some of these gaps are actually permanent and result from
     a transaction that is rolled back for some reason.  In this case, the Route Job must continue to watch
     for the gap to fill in and, at some point, eventually gives up and assumes the gap is permanent and can be skipped.  All of this
     must be done in some fashion that guarantees that gaps are routed when they fill in while also keeping
     routing as efficient as possible.
     </p>
     <p>
     SymmetricDS handles the issue of data gaps by making use of a table, <a href="data-model.html#table_data_gap" title="A.22.&nbsp;DATA_GAP">DATA_GAP</a>, to record
     gaps found in the data ids.  In fact, this table completely defines the entire range of data tha can be routed at any point in time.
     For a brand new instance of SymmetricDS, this table is empty
     and SymmetricDS creates a gap starting from data id of zero and ending with a very large number (defined by <code class="literal">routing.largest.gap.size</code>).
     At the start of a Route Job, the list of valid gaps (gaps with status of 'GP') is collected, and each gap is evaluated in turn.
     If a gap is sufficiently old (as defined by <code class="literal">routing.stale.dataid.gap.time.ms</code>, the gap
     is marked as skipped (status of 'SK') and will no longer be evaluated in future Route Jobs (note that the 'last' gap (the one with the highest starting data id) is never
     skipped).  If not skipped, then  <a href="data-model.html#table_data_event" title="A.23.&nbsp;DATA_EVENT">DATA_EVENT</a> is searched for data ids present in the gap.
     If one or more data ids is found in <a href="data-model.html#table_data_event" title="A.23.&nbsp;DATA_EVENT">DATA_EVENT</a>, then the current gap is marked with a status
     of OK, and new gap(s) are created to represent the data ids still missing in the gap's range.  This process is done for
     all gaps.  If the very last gap contained data, a new gap starting from the highest data id and ending at (highest data id + <code class="literal">routing.largest.gap.size</code>) is then created.
     This process has resulted in an updated list of gaps which may contain new data to be routed.
     </p>
   
     </div>
     </div>
     <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="controlling-synchronization"></a>5.2.2.&nbsp;Controlling Synchronization Frequency</h3></div></div></div>
        
        <p>
        The frequency of data synchronization is controlled by the coordination of a series of asynchronous events.   
        </p>    
        <p>
        The Route Job determines which nodes
        data will be sent to, as well as how much data will be batched together for transport.  When the <code class="literal">start.route.job</code> SymmetricDS property is set to 
        <code class="literal">true</code>, the frequency that routing occurs is controlled by the <code class="literal">job.routing.period.time.ms</code>.  Each time data is routed, the 
        <a href="data-model.html#table_data_ref" title="A.21.&nbsp;DATA_REF">DATA_REF</a> table is updated with the id of the last contiguous data row to have been processed.  This is done so the query to find
        unrouted data is optimal. 
        </p>
        <p>
        After data is routed, it awaits transport to the target nodes.  Transport can occur when a client node is configured to pull data or when the host node is configured to push data.  These
        events are controlled by the <span class="emphasis"><em>Push</em></span> and the <span class="emphasis"><em>Pull Jobs</em></span>.  When the <code class="literal">start.pull.job</code> SymmetricDS property is set to 
        <code class="literal">true</code>, the frequency that data is pulled is controlled by the <code class="literal">job.pull.period.time.ms</code>.  When the <code class="literal">start.push.job</code> SymmetricDS property is set to 
        <code class="literal">true</code>, the frequency that data is pushed is controlled by the <code class="literal">job.push.period.time.ms</code>.  Data is extracted by channel from the source database's 
        <a href="data-model.html#table_data" title="A.20.&nbsp;DATA">DATA</a> table at an interval controlled by the <code class="literal">extract_period_millis</code> column on the 
        <a href="data-model.html#table_channel" title="A.10.&nbsp;CHANNEL">CHANNEL</a> table.  The <code class="literal">last_extract_time</code> is 
        always recorded, by channel, on the <a href="data-model.html#table_node_channel_ctl" title="A.11.&nbsp;NODE_CHANNEL_CTL">NODE_CHANNEL_CTL</a> table for the host node's id.  When the Pull and Push Job run, if the extract period
        has not passed according to the last extract time, then the channel will be skipped for this run.  If the <code class="literal">extract_period_millis</code> is set to zero, data extraction will happen every time the jobs run.
        </p>
        <p>
        SymmetricDS also provides the ability to configure windows of time when synchronization is allowed.  This is done using the
        <a href="data-model.html#table_node_group_channel_window" title="A.12.&nbsp;NODE_GROUP_CHANNEL_WINDOW">NODE_GROUP_CHANNEL_WINDOW</a> 
        table.  A list of allowed time windows can be specified for a node group and a channel.  If one or more windows exist, then data will only be extracted and transported if the time
        of day falls within the window of time specified.  The configured times are always for the target node's local time.  If the <code class="literal">start_time</code> is greater than the <code class="literal">end_time</code>, then the window crosses
        over to the next day.
        </p>
        <p>
        All data loading may be disabled by setting the <code class="literal">dataloader.enable</code> property to false.  This has the effect of not allowing incoming synchronizations, while allowing outgoing
        synchronizations.  All data extractions may be disabled by setting the <code class="literal">dataextractor.enable</code> property to false.  These properties can be controlled by inserting into the 
        root server's <a href="data-model.html#table_parameter" title="A.16.&nbsp;PARAMETER">PARAMETER</a> table.  These properties affect every channel with the exception of the 'config' channel.  
        </p>
    </div>         
       
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="sync-triggers"></a>5.2.3.&nbsp;Sync Triggers Job</h3></div></div></div>
        
        <p>
            SymmetricDS examines the current configuration, corresponding database triggers,
            and the underlying tables to determine if database triggers need created or updated.
            The change activity is recorded on the <a href="data-model.html#table_trigger_hist" title="A.19.&nbsp;TRIGGER_HIST">TRIGGER_HIST</a> table with a reason for the
            change.  The following reasons for a change are possible:

            </p><div class="itemizedlist"><ul type="disc"><li>
                    <p>N - New trigger that has not been created before</p>
                </li><li>
                    <p>S - Schema changes in the table were detected</p>
                </li><li>
                    <p>C - Configuration changes in Trigger</p>
                </li><li>
                    <p>T - Trigger was missing</p>
                </li></ul></div><p>

            A configuration entry in Trigger without any history in Trigger Hist results in a new
            trigger being created (N).  The Trigger Hist stores a hash of the underlying table, so
            any alteration to the table causes the trigger to be rebuilt (S).  When the 
            <code class="literal">last_update_time</code> is changed on the Trigger entry, the configuration change causes
            the trigger to be rebuilt (C).  If an entry in Trigger Hist is missing the
            corresponding database trigger, the trigger is created (T).
        </p>
        <p>
            The process of examining triggers and rebuilding them is automatically run during startup and
            each night by the SyncTriggersJob.  The user can also manually run the process at any time 
            by invoking the <code class="literal">syncTriggers()</code> method over JMX.  The SyncTriggersJob is enabled by default 
            to run at 15 minutes past midnight.  If SymmetricDS is being run from a collection of servers
            (multiple instances of the same Node running against the same database), then locking
            should be enable to prevent database contention.  The following runtime properties
            control the behavior of the process.
            </p><div class="variablelist"><dl><dt><span class="term">
                        <span><strong class="command">start.synctriggers.job</strong></span>
                    </span></dt><dd>
                        <p>
                            Whether the sync triggers job is enabled for this node.
                            [&nbsp;Default:&nbsp;true&nbsp;]
                        </p>
                    </dd><dt><span class="term">
                        <span><strong class="command">job.synctriggers.aftermidnight.minutes</strong></span>
                    </span></dt><dd>
                        <p>
                            If scheduled, the sync triggers job will run nightly. This is how long after midnight
                            that job will run. [&nbsp;Default:&nbsp;15&nbsp;]
                        </p>
                    </dd><dt><span class="term">
                        <span><strong class="command">cluster.lock.during.sync.triggers</strong></span>
                    </span></dt><dd>
                        <p>
                            Indicate if the sync triggers job is clustered and requires a lock before running.
                            [&nbsp;Default:&nbsp;false&nbsp;]
                        </p>
                    </dd></dl></div><p>
        </p>
    </div> 
     </div>
     <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-publishing"></a>5.3.&nbsp;JMS Publishing</h2></div></div></div>
            
        <p>
            With the proper configuration SymmetricDS can publish XML messages of captured data changes to 
            JMS during routing or transactionally while data loading synchronized data into a target database.
            The following explains how to publish to JMS during synchronization to the target database. 
       </p>
       <p>     
            The XmlPublisherDataLoaderFilter is a
            <a href="extensions.html#extensions-data-loader-filter" title="6.2.&nbsp;IDataLoaderFilter">IDataLoaderFilter</a> that may be configured to 
            publish specific tables as an XML message to a JMS provider.
            See <a href="extensions.html" title="Chapter&nbsp;6.&nbsp;Extending SymmetricDS">Chapter&nbsp;6, <i xmlns:xlink="http://www.w3.org/1999/xlink">Extending SymmetricDS</i></a> for information on how 
            to configure an extension point.  If the publish to JMS fails, the batch will be marked in error, 
            the loaded data for the batch will be rolled back
            and the batch will be retried during the next synchronization run.            
        </p>
        <p>
        The following is an example extension point configuration that will publish four tables in XML with a root 
        tag of <span class="emphasis"><em>'sale'</em></span>.  Each XML message will be grouped by the batch and the column names identified by
        the groupByColumnNames property which have the same values.
                </p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="http://www.springframework.org/schema/beans 
           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-3.0.xsd"&gt;
 
    &lt;bean id="configuration-publishingFilter" 
      class="org.jumpmind.symmetric.integrate.XmlPublisherDataLoaderFilter"&gt;
        &lt;property name="xmlTagNameToUseForGroup" value="sale"/&gt;
        &lt;property name="tableNamesToPublishAsGroup"&gt;
            &lt;list&gt;
               &lt;value&gt;SALE_TX&lt;/value&gt;
               &lt;value&gt;SALE_LINE_ITEM&lt;/value&gt;
               &lt;value&gt;SALE_TAX&lt;/value&gt;
               &lt;value&gt;SALE_TOTAL&lt;/value&gt;
            &lt;/list&gt;            
        &lt;/property&gt;
        &lt;property name="groupByColumnNames"&gt;
            &lt;list&gt;
               &lt;value&gt;STORE_ID&lt;/value&gt;
               &lt;value&gt;BUSINESS_DAY&lt;/value&gt;
               &lt;value&gt;WORKSTATION_ID&lt;/value&gt;
               &lt;value&gt;TRANSACTION_ID&lt;/value&gt;
            &lt;/list&gt;                      
        &lt;/property&gt;
        &lt;property name="publisher"&gt;
           &lt;bean class="org.jumpmind.symmetric.integrate.SimpleJmsPublisher"&gt;
               &lt;property name="jmsTemplate" ref="definedSpringJmsTemplate"/&gt;
           &lt;/bean&gt;
        &lt;/property&gt;        
    &lt;/bean&gt;     
&lt;/beans&gt;</pre><p>        
        </p>
        <p>
          The publisher property on the XmlPublisherDataLoaderFilter takes an interface of type IPublisher.  The implementation
          demonstrated here is an implementation that publishes to JMS using Spring's 
          <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/jms.html#jms-jmstemplate" target="_top">JMS template</a>.
          Other implementations of IPublisher could easily publish the XML to other targets like an HTTP server, the file system or secure copy it to another server.
        </p>
        <p>
          The above configuration will publish XML similiar to the following:
            </p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;sale xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  id="0012010-01-220031234" nodeid="00001" time="1264187704155"&gt;
  &lt;row entity="SALE_TX" dml="I"&gt;
    &lt;data key="STORE_ID"&gt;001&lt;/data&gt;
    &lt;data key="BUSINESS_DAY"&gt;2010-01-22&lt;/data&gt;
    &lt;data key="WORKSTATION_ID"&gt;003&lt;/data&gt;
    &lt;data key="TRANSACTION_ID"&gt;1234&lt;/data&gt;
    &lt;data key="CASHIER_ID"&gt;010110&lt;/data&gt;
  &lt;/row&gt;        
  &lt;row entity="SALE_LINE_ITEM" dml="I"&gt;
    &lt;data key="STORE_ID"&gt;001&lt;/data&gt;
    &lt;data key="BUSINESS_DAY"&gt;2010-01-22&lt;/data&gt;
    &lt;data key="WORKSTATION_ID"&gt;003&lt;/data&gt;
    &lt;data key="TRANSACTION_ID"&gt;1234&lt;/data&gt;
    &lt;data key="SKU"&gt;9999999&lt;/data&gt;  
    &lt;data key="PRICE"&gt;10.00&lt;/data&gt;
    &lt;data key="DESC" xsi:nil="true"/&gt;
  &lt;/row&gt;        
  &lt;row entity="SALE_LINE_ITEM" dml="I"&gt;
    &lt;data key="STORE_ID"&gt;001&lt;/data&gt;
    &lt;data key="BUSINESS_DAY"&gt;2010-01-22&lt;/data&gt;
    &lt;data key="WORKSTATION_ID"&gt;003&lt;/data&gt;
    &lt;data key="TRANSACTION_ID"&gt;1234&lt;/data&gt;
    &lt;data key="SKU"&gt;9999999&lt;/data&gt;  
    &lt;data key="PRICE"&gt;10.00&lt;/data&gt;
    &lt;data key="DESC" xsi:nil="true"/&gt;
  &lt;/row&gt;
  &lt;row entity="SALE_TAX" dml="I"&gt;
    &lt;data key="STORE_ID"&gt;001&lt;/data&gt;
    &lt;data key="BUSINESS_DAY"&gt;2010-01-22&lt;/data&gt;
    &lt;data key="WORKSTATION_ID"&gt;003&lt;/data&gt;
    &lt;data key="TRANSACTION_ID"&gt;1234&lt;/data&gt;
    &lt;data key="AMOUNT"&gt;1.33&lt;/data&gt;  
  &lt;/row&gt;
  &lt;row entity="SALE_TOTAL" dml="I"&gt;
    &lt;data key="STORE_ID"&gt;001&lt;/data&gt;
    &lt;data key="BUSINESS_DAY"&gt;2010-01-22&lt;/data&gt;
    &lt;data key="WORKSTATION_ID"&gt;003&lt;/data&gt;
    &lt;data key="TRANSACTION_ID"&gt;1234&lt;/data&gt;
    &lt;data key="AMOUNT"&gt;21.33&lt;/data&gt;  
  &lt;/row&gt;
&lt;/sale&gt;
            </pre><p>     
            To publish JMS messages during routing
            the same pattern is valid, with the exception that the extension point would be the XmlPublisherDataRouter and the router 
            would be configured by setting the <code class="literal">router_type</code> of a <a href="data-model.html#table_router" title="A.14.&nbsp;ROUTER">ROUTER</a> to the Spring bean
            name of the registered extension point.  Of course, the router would need to be linked through <a href="data-model.html#table_trigger_router" title="A.15.&nbsp;TRIGGER_ROUTER">TRIGGER_ROUTER</a>s
            to each <a href="data-model.html#table_trigger" title="A.13.&nbsp;TRIGGER">TRIGGER</a>  table that needs published.                  
        </p>
    </div>     
<div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="deployment-options"></a>5.4.&nbsp;Deployment Options</h2></div></div></div>
        
        <p>An instance of SymmetricDS can be deployed in several ways:</p>
        <div class="itemizedlist"><ul type="disc"><li>
                <p>Web application archive (WAR) deployed to an application server</p>
                <p>
                    This option means packaging a WAR file and deploying to your favorite
                    web server, like Apache Tomcat.  It's a little more work, but you
                    can configure the web server to do whatever you need.  SymmetricDS can also 
                    be embedded in an existing web application, if desired.
                </p>                
            </li><li>
                <p>Standalone service that embeds Jetty web server</p>
                <p>
                    This option means running the <span class="emphasis"><em>sym</em></span> command line, which launches the built-in Jetty web server.  
                    This is a simple option because it is already provided, but you lose the flexibility to configure 
                    the web server any further.
                </p>
            </li><li>
                <p>Embedded as a Java library in an application</p>
                <p>
                    This option means you must write a wrapper Java program that runs
                    SymmetricDS.  You would probably use Jetty web server, which is also embeddable.
                    You could bring up an embedded database like Derby or H2.  You could configure the
                    web server, database, or SymmetricDS to do whatever you needed, but it's also
                    the most work of the three options discussed thus far.
                </p>
            </li><li>
                <p>Grails Application</p>
                <p>                
                    A <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://grails.org/plugin/symmetricds" target="_top">Grails SymmetricDS plugin</a> is 
                    provided at the default Grails plugin site.  This option ends up being a WAR deployment, but allows 
                    for the use of the Grails SDK for configuring and building the deployment.  The plugin also
                    provides Gorm (Hibernate) access to many of the core database tables.   
                </p>
            </li></ul></div>
        <p>
            The deployment model you choose depends on how much flexibility you need versus how easy you
            want it to be.  Both Jetty and Tomcat are excellent, scalable web servers that
            compete with each other and have great performance.  Most people choose either
            the <span class="emphasis"><em>Standalone</em></span> or <span class="emphasis"><em>Web Archive</em></span> with Tomcat 5.5 or 6.  Deploying to Tomcat
            is a good middle-of-the-road decision that requires a little more work for more flexibility.
        </p>
        <p>Next, we will go into a little more detail on the first three deployment options listed above.</p>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="deployment-options-web-archive"></a>5.4.1.&nbsp;Web Archive</h3></div></div></div>
            
            <p>
                As a web application archive, a WAR is deployed to an application server,
                such as Tomcat, Jetty, or JBoss.  The structure of the archive will have a <code class="literal">web.xml</code>
                file in the <code class="literal">WEB-INF</code> folder, an appropriately configured <code class="filename">symmetric.properties</code> file in the <code class="literal">WEB-INF/classes</code> folder,
                and the required JAR files in the <code class="literal">WEB-INF/lib</code> folder.
            </p>
            <div class="mediaobject"><img src="./images/symmetric_war.gif"></div>
            <p>
                A war file can be generated using the standalone installation's sym utility and the 
                --create-war option.  The command requires the name of the war file to generate.  It 
                essentially packages up the web directory, the conf directory and includes an optional
                properties file.  Note that if a properties file is included, it will be copied to 
                WEB-INF/classes/symmetric.properties.  This is the same location conf/symmetric.properties
                would have been copied to.  The generated war distribution uses the same web.xml as the standalone
                deployment. 
            </p>
            <p>
                <span><strong class="command">../bin/sym -p my-symmetric-ds.properties --create-war /some/path/to/symmetric-ds.war</strong></span>
            </p>
            <p>
                The <code class="literal">web.base.servlet.path</code> property in <code class="filename">symmetric.properties</code> can be set if the SymmetricServlet needs to
                coexist with other Servlets.  By default, the value is blank.  If you set it to, say, <code class="literal">web.base.servlet.path=sync</code> for exmaple,
                <code class="literal">registration.url</code> would be <code class="literal">http://server:port/sync</code>.
            </p>            
        </div>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="deployment-options-standalone"></a>5.4.2.&nbsp;Standalone</h3></div></div></div>
            
            <p>
                A standalone service can use the <code class="literal">sym</code> command line options to start
                a server.  An embedded instance of Jetty is used to service web
                requests for all the servlets.
            </p>
            <pre class="programlisting">/symmetric/bin/sym --properties root.properties --port 8080 --server
</pre>
            <p>
                This example starts the SymmetricDS server on port 8080 with the startup
                properties found in the <code class="filename">root.properties</code> file.
            </p>
        </div>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="deployment-options-embedded"></a>5.4.3.&nbsp;Embedded</h3></div></div></div>
            
            <p>
                A Java application with the SymmetricDS Java Archive (JAR) libraries in its
                classpath can use the <code class="literal">SymmetricWebServer</code> to start the server.
            </p>
            <pre class="programlisting">
import org.jumpmind.symmetric.SymmetricWebServer;

public class StartSymmetricEngine {

    /**
     * Start an engine that is configured by two properties files. One is
     * packaged with the application and contains overridden properties that are
     * specific to the application. The other is found in the application's
     * working directory. It can be used to setup environment specific
     * properties.
     */
    public static void main(String[] args) throws Exception {
        
        // Specify the properties file and the web directory
        SymmetricWebServer node = new SymmetricWebServer(
                                   "classpath://my-application.properties", "web");
                             
        // indicates that the start() method should return      
        node.setJoin(false);

        // this will create the database, sync triggers, start jobs running
        node.start(8080);
        
        // this will stop the node
        node.stop();
    }   

}</pre>
            <p>
                This example starts the SymmetricDS server on port 8080 with a startup properties
                file that is found on the application's classpath to provide properties that 
                override the default values.  Note if the properties file should be found on the
                file system the property file name would be prepended with file://.
            </p>
            <p>
                The second parameter to the web server is the name of the directory where the web.xml
                for the application can be found.  You may use the web.xml from the standalone 
                deployment.  In this example you would place the web.xml in the web/WEB-INF/ directory.
            </p>
        </div>
    </div> 
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="running-service"></a>5.5.&nbsp;Running SymmetricDS as a Service</h2></div></div></div>
    
        <p>
    SymmetricDS can be configured to start and run as a service in both Windows and *nix platforms.
    </p>
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="running-service-windows"></a>5.5.1.&nbsp;Running as a Windows Service</h3></div></div></div>
        
        <p>
            SymmetricDS uses the
            <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://wrapper.tanukisoftware.org/" target="_top">Java Service Wrapper</a>
            product from Tanuki Software to run in the background as a Windows system service.
            The Java Service Wrapper executable is named <code class="filename">sym_service.exe</code>
            so it can be easily identified from a list of running processes.
            To install the service, use the provided script:
            </p><pre class="programlisting">bin\install_service.bat</pre><p>
        </p>
        <p>
            The service configuration is found in <code class="filename">conf/sym_service.conf</code>.
            Edit this file if you want to change the default port number (8080), initial memory size
            (256 MB), log file size (10 MB), or other settings.
            When started, the server will look in the <code class="filename">conf</code> directory
            for the <code class="filename">symmetric.properties</code> file
            and the  <code class="filename">log4j.xml</code> file.
            Logging for standard out, error, and application are written to the
            <code class="filename">logs</code> directory.
        </p>
        <p>
            Most configuration changes do not require the service to be re-installed. 
            To un-install the service, use the provided script:
            </p><pre class="programlisting">bin\uninstall_service.bat</pre><p>
        </p>
        <p>
            Use the <span><strong class="command">net</strong></span> command to start and stop the service: 
            </p><pre class="programlisting">net start symmetric
net stop symmetric</pre><p>
        </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="running-service-unix"></a>5.5.2.&nbsp;Running as a *nix Service</h3></div></div></div>
        
        <p>
            SymmetricDS uses the
            <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://wrapper.tanukisoftware.org/" target="_top">Java Service Wrapper</a>
            product from Tanuki Software to run in the background as a Unix system service.
            The Java Service Wrapper executable is named <code class="filename">sym_service</code>
            so it can be easily identified from a list of running processes.
            The service configuration is found in <code class="filename">conf/sym_service.conf</code>.
            Edit this file if you want to change the default port number (8080), initial memory size
            (256 MB), log file size (10 MB), or other settings.
        </p>
        <p>
            An init script is provided to work with standard Unix run configuration levels.
            The <code class="filename">sym_service.initd</code> file follows the
            Linux Standard Base specification, which should work on many systems, including
            Fedora and Debian-based distributions.  
            To install the script, copy it into the system init directory:
        </p>
        <p>
            </p><pre class="programlisting">cp bin/sym_service.initd /etc/init.d/sym_service</pre><p>
        </p>
        <p>
            Edit the init script to set the SYM_HOME variable to the directory
            where SymmetricDS is located.  The init script calls the
            <code class="filename">sym_service</code> executable.
        </p>
        <p>
            To enable the service to run automatically when the system is started:
            </p><pre class="programlisting">/sbin/chkconfig --add sym_service</pre><p>
        </p>
        <p>
            To disable the service from running automatically:
            </p><pre class="programlisting">/sbin/chkconfig --del sym_service</pre><p>
        </p>
        <p>
            On Suse Linux install the service by calling:
            </p><pre class="programlisting">/usr/lib/lsb/install_initd sym_service</pre><p>
            Remove the service by calling:
            </p><pre class="programlisting">/usr/lib/lsb/remove_initd sym_service</pre><p>
        </p>          
        <p>
            Use the <span><strong class="command">service</strong></span> command to start, stop, and query
            the status of the service: 
            </p><pre class="programlisting">/sbin/service sym_service start
/sbin/service sym_service stop
/sbin/service sym_service status</pre><p>
        </p>  
        <p>
            Alternatively, call the init.d script directly:
            </p><pre class="programlisting">/etc/init.d/sym_service start
/etc/init.d/sym_service stop
/etc/init.d/sym_service status
            </pre><p>
        </p>    
    </div>
    </div>
        <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="clustering"></a>5.6.&nbsp;Clustering</h2></div></div></div>
        
        <p>
        A single SymmetricDS node may be clustered across a series of instances, creating a web farm.  A node might be clustered to provide load balancing and failover, for example.
        </p>
        <p>
        When clustered, a hardware load balancer is typically used
        to round robin client requests to the cluster.  The load balancer should be configured for stateless connections.  
        Also, the <code class="literal">sync.url</code> (discussed in <a href="configuration.html#configuration-node-properties" title="4.1.&nbsp;Node Properties">Section&nbsp;4.1, &#8220;Node Properties&#8221;</a>)
        SymmetricDS property should be set to the URL of the load balancer.  
        </p>
        <p>
        If the cluster will be running any of the SymmetricDS jobs, then the <code class="literal">cluster.lock.enabled</code> property should be set to <code class="literal">true</code>. 
        By setting this property to true, SymmetricDS will use a row in the <a href="data-model.html#table_lock" title="A.26.&nbsp;LOCK">LOCK</a> table as a semaphore to make sure that only one instance at a time
        runs a job.  When a lock is acquired, a row is updated in the lock table with the time of the lock and the server id of the locking job.  The lock time is set back to null
        when the job is finished running.  Another instance of SymmetricDS cannot aquire a lock until the locking instance (according to the server id) releases the lock.  If an 
        instance is terminated while the lock is still held, an instance with the same server id is allowed to reaquire the lock.  If the locking instance remains down, the lock can be 
        broken after a period of time, specified by the <code class="literal">cluster.lock.timeout.ms</code> property, has expired.  Note that if the job is still running and the lock
        expires, two jobs could be running at the same time which could cause database deadlocks. 
        </p>
        <p>
        By default, the locking server id is the hostname of the server.  If two clustered instances are running on the same server, then the <code class="literal">cluster.server.id</code> property 
        may be set to indicate the name that the instance should use for its server id.
        </p>
        <p>
        When deploying SymmetricDS to an application server like Tomcat or JBoss, no special session clustering needs to be configured for the application server.  
        </p>
    </div>   
      <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="encrypted-passwords"></a>5.7.&nbsp;Encrypted Passwords</h2></div></div></div>
        
        <p>
            The <code class="literal">db.user</code> and <code class="literal">db.password</code> properties will accept encrypted text, which protects
            against casual observation.  The text is prefixed with <code class="literal">enc:</code> to indicate
            that it is encrypted.  To encrypt text, use the following command:

            </p><pre class="programlisting">sym -e secret</pre><p>

            The text is encrypted using a secret key named "sym.secret" that is retrieved from a keystore file. 
            By default, the keystore is located in <code class="filename">security/keystore</code>.
            The location and filename of the keystore can be overridden by setting the "sym.keystore.file" system property.
            If the secret key is not found, the system will generate and install a secret key for use with Triple DES cipher.
        </p>
        <p>
            Generate a new secret key for encryption using the <code class="literal">keytool</code>
            command that comes with the JRE.  If there is an existing key in the keystore, first remove it:

            </p><pre class="programlisting">keytool -keystore keystore -storepass changeit -storetype jceks \
   -alias sym.secret -delete</pre><p>

            Then generate a secret key, specifying a cipher algorithm and key size.
            Commonly used algorithms that are supported include aes, blowfish, desede, and rc4.

            </p><pre class="programlisting">keytool -keystore keystore -storepass changeit -storetype jceks \
   -alias sym.secret -genseckey -keyalg aes -keysize 128</pre><p>

            If using an alternative provider, place the provider JAR file in the SymmetricDS <code class="filename">lib</code> folder. 
            The provider class name should be installed in the JRE security properties or specified on the command line.
            To install in the JRE, edit the JRE <code class="filename">lib/security/java.security</code> file
            and set a <code class="literal">security.provider.i</code> property for the provider class name.
            Or, the provider can be specified on the command line instead.
            Both <code class="literal">keytool</code> and <code class="literal">sym</code> accept command line arguments for the provider class name.
            For example, using the Bouncy Castle provider, the command line options would look like:

            </p><pre class="programlisting">keytool -keystore keystore -storepass changeit -storetype jceks \
   -alias sym.secret -genseckey -keyalg idea -keysize 56 \
   -providerClass org.bouncycastle.jce.provider.BouncyCastleProvider \
   -providerPath ..\lib\bcprov-ext.jar</pre><p>
            </p><pre class="programlisting">sym -jcep org.bouncycastle.jce.provider.BouncyCastleProvider -e secret</pre><p>

            To customize the encryption, write a Java class that implements the ISecurityService or extends the default SecurityService, and place
            the class on the classpath in either <code class="filename">lib</code> or
            <code class="filename">web/WEB-INF/lib</code> folders.
            Then, in the <code class="filename">symmetric.properties</code> specify your class name for the security service.

            </p><pre class="programlisting">security.service.class.name=org.jumpmind.symmetric.service.impl.SecurityService</pre><p>

            Remember to specify your properties file when encrypting passwords, so it will use your custom ISecurityService.

            </p><pre class="programlisting">sym -p symmetric.properties -e secret</pre><p>
        </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="secure-transport"></a>5.8.&nbsp;Secure Transport</h2></div></div></div>
        
        <p>
            By specifying the "https" protocol for a URL, SymmetricDS will communicate over
            Secure Sockets Layer (SSL) for an encrypted transport.  The following properties
            need to be set with "https" in the URL:
            </p><div class="variablelist"><dl><dt><span class="term">
                        <span><strong class="command">sync.url</strong></span>
                    </span></dt><dd>
                        <p>
                            This is the URL of the current node, so if you want to force other
                            nodes to communicate over SSL with this node, you specify "https" in the URL.
                        </p>
                    </dd><dt><span class="term">
                        <span><strong class="command">registration.url</strong></span>
                    </span></dt><dd>
                        <p>
                            This is the URL where the node will connect for registration when it 
                            first starts up.  To protect the registration with SSL, you specify
                            "https" in the URL.
                        </p>
                    </dd></dl></div><p>
            For incoming HTTPS connections, SymmetricDS depends on the webserver where
            it is deployed, so the webserver must be configured for HTTPS.
            As a standalone deployment, the "sym" launcher command provides options for 
            enabling HTTPS support.
        </p>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="secure-transport-sym"></a>5.8.1.&nbsp;Sym Launcher</h3></div></div></div>
            
            <p>
                The "sym" launch command uses Jetty as an embedded web server.
                Using command line options, the web server can be told to listen for 
                HTTP, HTTPS, or both.
            </p>
            <p>
                <span><strong class="command">sym --port 8080 --server</strong></span>
            </p>
            <p>
                <span><strong class="command">sym --secure-port 8443 --secure-server</strong></span>
            </p>
            <p>
                <span><strong class="command">sym --port 8080 --secure-port 8443 --mixed-server</strong></span>
            </p>
        </div>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="secure-transport-tomcat"></a>5.8.2.&nbsp;Tomcat</h3></div></div></div>
            
            <p>
                If you deploy SymmetricDS to Apache Tomcat, it can be secured by editing the
                <code class="filename">TOMCAT_HOME/conf/server.xml</code>
                configuration file.  There is already a line that can be uncommented
                and changed to the following:
                
                </p><pre class="programlisting">
&lt;Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true" 
  maxThreads="150" scheme="https" secure="true" 
  clientAuth="false" sslProtocol="TLS"
  keystoreFile="/symmetric-ds-1.x.x/security/keystore" /&gt;</pre><p>
            </p>
        </div>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="secure-transport-keystore"></a>5.8.3.&nbsp;Keystores</h3></div></div></div>
            
            <p>
                When SymmetricDS connects to a URL with HTTPS, Java checks the validity of the
                certificate using the built-in trusted keystore located at
                <code class="filename">JRE_HOME/lib/security/cacerts</code>.
                The "sym" launcher command overrides the trusted keystore to use its own
                trusted keystore instead, which is located at
                <code class="filename">security/cacerts</code>.
                This keystore contains the certificate aliased as "sym" for use in testing
                and easing deployments.                
                The trusted keystore can be overridden
                by specifying the <code class="literal">javax.net.ssl.trustStore</code> system property.
            </p>
            <p>
                When SymmetricDS is run as a secure server with the "sym" launcher,
                it accepts incoming requests using the key installed in the keystore
                located at
                <code class="filename">security/keystore</code>.
                The default key is provided for convenience of testing, but should be
                re-generated for security.
            </p>
        </div>
        <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="secure-transport-keys"></a>5.8.4.&nbsp;Generating Keys</h3></div></div></div>
            
            <p>
                To generate new keys and install a server certificate, use the
                following steps:
            </p>
            <div class="procedure"><ol type="1"><li>
                    <p>
                        Open a command prompt and navigate to the
                        <code class="filename">security</code>
                        subdirectory of your SymmetricDS installation on the server to which
                        communication will be secured (typically the "root" or "central office" server).
                    </p>
                </li><li>
                    <p>Delete the old key pair and certificate.</p>
                    <p>
                        <span><strong class="command">keytool -keystore keystore -delete -alias sym</strong></span>
                    </p>
                    <p>
                        <span><strong class="command">keytool -keystore cacerts -delete -alias sym</strong></span>
                    </p>
                    <pre class="programlisting">Enter keystore password:  changeit</pre>
                </li><li>
                    <p>Generate a new key pair.  Note that the first name/last name (the "CN") must match
                    the fully qualified hostname the client will be using to communcate to the server.</p>
                    <p>
                        <span><strong class="command">keytool -keystore keystore -alias sym -genkey -keyalg RSA -validity 10950</strong></span>
                    </p>
                    <pre class="programlisting">
Enter keystore password:  changeit
What is your first and last name?
  [Unknown]:  localhost
What is the name of your organizational unit?
  [Unknown]:  SymmetricDS
What is the name of your organization?
  [Unknown]:  JumpMind
What is the name of your City or Locality?
  [Unknown]:
What is the name of your State or Province?
  [Unknown]:
What is the two-letter country code for this unit?
  [Unknown]:
Is CN=localhost, OU=SymmetricDS, O=JumpMind, L=Unknown, ST=Unknown, C=Unknown
correct?
  [no]:  yes

Enter key password for &lt;sym&gt;
        (RETURN if same as keystore password):</pre>
                </li><li>
                    <p>Export the certificate from the private keystore.</p>
                    <p>
                        <span><strong class="command">keytool -keystore keystore -export -alias sym -rfc -file sym.cer</strong></span>
                    </p>
                </li><li>
                    <p>Install the certificate in the trusted keystore.</p>
                    <p>
                        <span><strong class="command">keytool -keystore cacerts -import -alias sym -file sym.cer</strong></span>
                    </p>
                </li><li>
                    <p>Copy the cacerts file that is generated by this process to
                    the <code class="filename">security</code> directory of each client's SymmetricDS installation.</p>
                </li></ol></div>
        </div>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="basic-auth"></a>5.9.&nbsp;Basic Authentication</h2></div></div></div>
        
        <p>
            SymmetricDS supports basic authentication for client and server nodes. 
            To configure a client node to use basic authentication when communicating with a server node, 
            specify the following startup parameters:
        </p>
            <div class="variablelist"><dl><dt><span class="term">
                        <span><strong class="command">http.basic.auth.username</strong></span>
                    </span></dt><dd>
                        <p>
                            username for client node basic authentication.
                            [&nbsp;Default:&nbsp;]
                        </p>
                    </dd><dt><span class="term">
                        <span><strong class="command">http.basic.auth.password</strong></span>
                    </span></dt><dd>
                        <p>
                            password for client node basic authentication.
                            [&nbsp;Default:&nbsp;]
                        </p>
                    </dd></dl></div>
        <p>
            The SymmetricDS Standalone and Embedded Server also support basic authentication.
            This feature is enabled by specifying the basic authentication username and
            password using the following startup parameters:
        </p>
            <div class="variablelist"><dl><dt><span class="term">
                        <span><strong class="command">embedded.webserver.basic.auth.username</strong></span>
                    </span></dt><dd>
                        <p>
                            username for basic authentication for an embedded server
                            or standalone server node.
                            [&nbsp;Default:&nbsp;]
                        </p>
                    </dd><dt><span class="term">
                        <span><strong class="command">embedded.webserver.basic.auth.password</strong></span>
                    </span></dt><dd>
                        <p>
                            password for basic authentication for an embedded server
                            or standalone server node.
                            [&nbsp;Default:&nbsp;]
                        </p>
                    </dd></dl></div>
        <p>
            If the server node is deployed to Tomcat or another application server as a WAR or EAR file, then 
            basic authentication is setup with the standard configuration in the WEB.xml file. 
        </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multi-server"></a>5.10.&nbsp;Multi-Server Mode</h2></div></div></div>
        
        <p>
            SymmetricDS supports running multiple SymmetricDS instances that leverage the same web server in the same
            process.  This mode can be turned on in the <code class="code">web/WEB-INF/web.xml</code> file.  By default, <code class="code">multiServerMode</code>
            is turned off. 
        </p>
            <pre class="programlisting">
    &lt;context-param&gt;
        &lt;param-name&gt;multiServerMode&lt;/param-name&gt;
        &lt;param-value&gt;true&lt;/param-value&gt;
    &lt;/context-param&gt;
</pre>
        <p>
            When <code class="code">multiServerMode</code> is turned on, SymmetricDS will initialize itself with an instance of 
            a node for each properties file found in the <code class="code">engines</code> directory.  Each node will inherit 
            common properties from <code class="code">conf/symmetric.properties</code>.   Each properties file must specify the 
            minimum required properties to define a single node.  In addition, the properties file is required to also specify
            a property, <code class="code">engine.name</code>, that provides a unique name for the node's engine.  
        </p>        
    </div>    
</div><div xmlns:fo="http://www.w3.org/1999/XSL/Format" class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="30%" align="left"><a accesskey="p" href="configuration.html">Prev</a>&nbsp;</td><td width="40%" align="center"><a accesskey="h" href="user-guide.html">Home</a></td><td width="30%" align="right">&nbsp;<a accesskey="n" href="extensions.html">Next</a></td></tr><tr><td width="30%" align="left" valign="top">Chapter&nbsp;4.&nbsp;Configuration&nbsp;</td><td width="40%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.symmetricds.org/" title="SymmetricDS">SymmetricDS
                                        </a></span></td><td width="30%" align="right" valign="top">&nbsp;Chapter&nbsp;6.&nbsp;Extending SymmetricDS</td></tr></table></div></body></html>